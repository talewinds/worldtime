<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WorldTime Pro â€” Final Edition (Stable)</title>
<meta name="description" content="WorldTime Pro â€” Global time zone comparator, meeting planner, DST ticker, sunrise/sunset, share/embed, and responsive design.">
<link rel="icon" href="data:,">
<style>
:root{
  --wtp-bg:#071323; --wtp-card:#0d1b2a; --wtp-muted:#9fb0c8; --wtp-accent:#a23a3a; --wtp-accent2:#3b82f6;
  --wtp-glass:rgba(255,255,255,0.03); --wtp-radius:12px; color-scheme: dark;
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial; margin:0;padding:18px;background:linear-gradient(180deg,#03101a,#071323);color:#e6f0fb;min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:0 auto}
.wtp-header{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
.wtp-titleRow{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.wtp-h1{font-size:20px;margin:0}
.wtp-tag{color:var(--wtp-muted);font-size:13px}
.wtp-seo{margin-top:8px;color:#dbeafe;background:linear-gradient(90deg, rgba(59,130,246,0.04), rgba(162,58,58,0.02));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:14px}

/* layout */
.wtp-row{display:flex;gap:12px;align-items:flex-start}
.wtp-col{background:var(--wtp-card);border-radius:var(--wtp-radius);padding:12px;border:1px solid rgba(255,255,255,0.03);flex:1}
.wtp-col-side{flex:0 0 380px;max-width:380px}

/* controls */
.wtp-controls{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.wtp-input,.wtp-select,.wtp-time,.wtp-date,.wtp-num{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px;border-radius:8px;outline:none}
.wtp-btn{background:var(--wtp-accent);border:0;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
.wtp-btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit}
.wtp-small{font-size:13px;padding:6px 10px;border-radius:6px}

/* suggestions */
.wtp-suggestions{position:relative}
.wtp-suggest-list{position:absolute;z-index:40;left:0;right:0;background:var(--wtp-card);border:1px solid rgba(255,255,255,0.03);border-radius:8px;padding:6px;margin-top:6px;max-height:260px;overflow:auto}
.wtp-suggest-item{padding:8px;border-radius:6px;cursor:pointer}
.wtp-suggest-item:hover,.wtp-suggest-item.active{background:rgba(255,255,255,0.02)}

/* grid & cards */
.wtp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px}
.wtp-card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));position:relative;border:1px solid rgba(255,255,255,0.02)}
.wtp-flag{font-size:22px;margin-right:8px}
.wtp-timebig{font-weight:700;font-size:18px}
.wtp-meta{color:var(--wtp-muted);font-size:12px}
.wtp-tooltip{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 10px);background:var(--wtp-glass);backdrop-filter:blur(6px);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);min-width:240px;display:none;z-index:30}
.wtp-tooltip.show{display:block}

/* timeline */
.wtp-timeline{overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:8px;border-radius:10px;margin-top:10px}
.wtp-hourbar{display:flex;gap:6px;align-items:center}
.wtp-hour{flex:0 0 48px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid rgba(255,255,255,0.03)}
.wtp-hour.now{background:linear-gradient(180deg, rgba(162,58,58,0.12), rgba(162,58,58,0.06));border-color:rgba(162,58,58,0.25)}
.wtp-hour.selected{background:linear-gradient(180deg, rgba(59,130,246,0.12), rgba(59,130,246,0.06));border-color:rgba(59,130,246,0.25)}
.wtp-cityrow{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.wtp-citylabel{width:160px;flex:0 0 160px}

/* vertical slider */
.wtp-vertWrap{height:220px;display:flex;align-items:center;justify-content:center}
.wtp-vertRange{writing-mode:bt-lr;-webkit-appearance:none;appearance:none;width:160px;transform: rotate(-90deg);}

/* map */
#wtp-map{height:260px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-top:8px}

/* utilities */
.wtp-tools .wtp-tool{padding:10px;border-radius:10px;background:rgba(255,255,255,0.015);margin-bottom:10px}

/* ticker */
.wtp-ticker{background:linear-gradient(90deg,#0b1b2a,#071323);padding:8px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);overflow:hidden;white-space:nowrap}
.wtp-ticker span{display:inline-block;padding-right:28px;color:var(--wtp-muted)}

/* footer */
.wtp-footer{margin-top:14px;color:var(--wtp-muted);text-align:center;font-size:13px}

/* responsive */
@media (max-width:980px){ .wtp-row{flex-direction:column} .wtp-col-side{max-width:none;flex:1} .wtp-citylabel{width:120px;flex:0 0 120px} .wtp-hour{flex:0 0 40px} #wtp-map{height:200px} .wtp-vertWrap{display:none} }
</style>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Optionally include Leaflet.markercluster in your repo if you want clustering -->
<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script> -->

</head>
<body>
  <div class="container">
    <header class="wtp-header" role="banner">
      <div class="wtp-titleRow">
        <h1 class="wtp-h1">WorldTime Pro: Global Meeting Scheduler & Time Zone Comparator</h1>
        <div class="wtp-tag">Never guess a meeting time again â€” find the best slot across any time zone.</div>
      </div>

      <div class="wtp-seo" id="wtp-seo">
        WorldTime Pro is the ultimate free world clock and time zone meeting planner for global teams, remote workers, and international travelers. Easily compare time zones for New York, London, Mumbai and hundreds more. Our Meeting Planner instantly scores and suggests the best universal time slots to maximize attendance across all your cities (optimizing for 9 AM to 6 PM local working hours). Features include a real-time DST ticker, sunrise/sunset times, time converters (e.g., EST to IST), and embeddable widgets for your website. No sign-up or backend requiredâ€”start planning instantly.
      </div>
    </header>

    <div class="wtp-ticker" id="wtp-dstTicker" aria-live="polite"><span id="wtp-dstText">Scanning for upcoming DST changes for your cities...</span></div>

    <div class="wtp-row" role="main">
      <!-- Main Column -->
      <div class="wtp-col" id="wtp-main">
        <div class="wtp-controls" role="region" aria-label="City controls">
          <div style="flex:1">
            <input id="wtp-citySearch" class="wtp-input" type="text" placeholder="Search city or IANA zone (e.g. New York or Europe/London)" aria-label="City search"/>
            <div id="wtp-suggestions" class="wtp-suggestions" aria-hidden="true"></div>
          </div>

          <button id="wtp-addCity" class="wtp-btn">Add</button>

          <select id="wtp-preset" class="wtp-select" aria-label="Popular presets">
            <option value="">Popular presets</option>
            <option>New York, USA|America/New_York</option>
            <option>London, UK|Europe/London</option>
            <option>Mumbai, India|Asia/Kolkata</option>
            <option>Dubai, UAE|Asia/Dubai</option>
            <option>Tokyo, Japan|Asia/Tokyo</option>
            <option>Sydney, AU|Australia/Sydney</option>
          </select>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="wtp-shareBtn" class="wtp-btn">Share</button>
            <button id="wtp-exportImage" class="wtp-btn wtp-ghost">Export Image</button>
            <button id="wtp-resetBtn" class="wtp-btn wtp-ghost">Reset</button>
          </div>
        </div>

        <div id="wtp-cards" class="wtp-grid" aria-live="polite" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:flex-start">
          <div style="flex:1">
            <h3 style="margin:6px 0">24-Hour Comparator</h3>
            <div id="wtp-timeline" class="wtp-timeline" aria-hidden="false"></div>
          </div>

          <div style="width:240px">
            <label class="wtp-meta">Vertical hour slider (highlight)</label>
            <div class="wtp-vertWrap">
              <input id="wtp-vertSlider" class="wtp-vertRange" type="range" min="0" max="23" step="1" value="0" aria-label="Hour highlight"/>
            </div>
            <div class="wtp-meta" id="wtp-vertLabel">Highlight hour: 00</div>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

        <h3 style="margin:6px 0">Meeting Planner & Suggestions</h3>
        <div class="wtp-planner" style="display:grid;grid-template-columns:1fr 360px;gap:10px">
          <div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <input id="wtp-meetingDate" class="wtp-date" type="date" />
              <input id="wtp-meetingTime" class="wtp-time" type="time" />
              <select id="wtp-meetingDuration" class="wtp-select">
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60" selected>60 min</option>
                <option value="90">90 min</option>
              </select>
              <button id="wtp-applyPlan" class="wtp-btn">Apply</button>
            </div>
            <div id="wtp-plannerResult" style="max-height:300px;overflow:auto;padding:6px"></div>
          </div>

          <div class="wtp-tools">
            <div class="wtp-tool">
              <strong>Quick Converters</strong>
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <button class="wtp-presetConv wtp-small" data-from="America/New_York" data-to="Asia/Kolkata">EST â†’ IST</button>
                <button class="wtp-presetConv wtp-small" data-from="America/Los_Angeles" data-to="Asia/Kolkata">PST â†’ IST</button>
                <button class="wtp-presetConv wtp-small" data-from="Etc/UTC" data-to="Asia/Kolkata">GMT â†’ IST</button>
                <button id="wtp-swapConv" class="wtp-small wtp-ghost">Swap</button>
              </div>

              <div style="display:flex;gap:6px;margin-top:8px">
                <select id="wtp-convFrom" class="wtp-select"></select>
                <select id="wtp-convTo" class="wtp-select"></select>
                <input id="wtp-convTime" class="wtp-time" type="time" />
                <button id="wtp-convBtn" class="wtp-btn">Convert</button>
              </div>
              <div id="wtp-convOut" style="margin-top:6px;color:var(--wtp-muted)"></div>
            </div>

            <div class="wtp-tool" style="margin-top:10px">
              <strong>Embeddable Widget</strong>
              <div style="font-size:13px;margin-top:8px">Paste this iframe on your blog:</div>
              <pre id="wtp-embedCode" style="background:rgba(0,0,0,0.2);padding:6px;border-radius:6px;margin-top:8px;font-size:12px"></pre>
              <button id="wtp-copyEmbed" class="wtp-btn">Copy</button>
            </div>

            <div class="wtp-tool" style="margin-top:10px">
              <strong>Share / Save</strong>
              <div style="margin-top:8px"><input id="wtp-shareLink" class="wtp-input" readonly style="width:100%"/></div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;text-align:center;">
          <div id="wtp-adContainer" style="display:flex;justify-content:center;margin-top:8px">
            <div style="width:320px;height:50px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;color:var(--wtp-muted)">Ad placeholder â€” paste AdSense unit here</div>
          </div>
        </div>
      </div>

      <!-- Side column -->
      <aside class="wtp-col wtp-col-side" role="complementary">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <strong style="flex:1">Utilities & Map</strong>
          <button id="wtp-resetTools" class="wtp-btn wtp-ghost">Reset</button>
        </div>

        <div id="wtp-map"></div>

        <div style="margin-top:10px" class="wtp-tools">
          <div class="wtp-tool">
            <strong>Sunrise / Sunset</strong>
            <div class="wtp-meta" style="margin-top:8px">Sunrise/sunset times show automatically on each city card (when coords available).</div>
          </div>

          <div class="wtp-tool" style="margin-top:10px">
            <strong>Countdown</strong>
            <div style="margin-top:8px;display:flex;gap:6px">
              <input id="wtp-countDate" class="wtp-date" type="date" />
              <input id="wtp-countTime" class="wtp-time" type="time" />
              <button id="wtp-startCount" class="wtp-btn">Start</button>
            </div>
            <div id="wtp-countRes" style="margin-top:8px;color:var(--wtp-muted)"></div>
          </div>

        </div>

        <div style="margin-top:12px;color:var(--wtp-muted);font-size:13px">
          <strong>Notes</strong>
          <ul>
            <li>Push this file to GitHub and enable Pages (root). No backend required.</li>
            <li>If you want the IANA DB bundled locally (recommended for reliability), say "bundle IANA".</li>
          </ul>
        </div>
      </aside>
    </div>

    <footer class="wtp-footer">
      Built with Luxon, Fuse.js, Leaflet, SunCalc and html2canvas. Links: <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a> â€¢ <a href="https://developers.google.com/adsense" target="_blank" rel="noopener">AdSense</a>
    </footer>
  </div>

<script>
/* WorldTime Pro â€” patched single-file build
   - fixes: addCityFromInput, initMap improvements, robust boot order, single tick loop
*/

/* --- Short aliases & libs --- */
const { DateTime } = luxon;
const base64url = {
  encode: (str) => {
    const utf8 = new TextEncoder().encode(String(str));
    let b = '';
    for (let i = 0; i < utf8.length; i++) b += String.fromCharCode(utf8[i]);
    return btoa(b).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  },
  decode: (s) => {
    if (!s) return '';
    s = s.replace(/-/g, '+').replace(/_/g, '/');
    while (s.length % 4) s += '=';
    const binary = atob(s);
    const bytes = new Uint8Array(binary.length);
    for (let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }
};

/* --- DOM refs --- */
const $ = id => document.getElementById(id);
const cardsEl = $('wtp-cards');
const searchInput = $('wtp-citySearch');
const addBtn = $('wtp-addCity');
const presetEl = $('wtp-preset');
const timelineEl = $('wtp-timeline');
const vertSlider = $('wtp-vertSlider');
const vertLabel = $('wtp-vertLabel');
const plannerResult = $('wtp-plannerResult');
const meetingDate = $('wtp-meetingDate');
const meetingTime = $('wtp-meetingTime');
const meetingDuration = $('wtp-meetingDuration');
const applyPlanBtn = $('wtp-applyPlan');
const convFrom = $('wtp-convFrom');
const convTo = $('wtp-convTo');
const convTime = $('wtp-convTime');
const convBtn = $('wtp-convBtn');
const convOut = $('wtp-convOut');
const suggestionsWrap = $('wtp-suggestions');
const embedCode = $('wtp-embedCode');
const copyEmbed = $('wtp-copyEmbed');
const shareBtn = $('wtp-shareBtn');
const shareLink = $('wtp-shareLink');
const exportImageBtn = $('wtp-exportImage');
const dstText = $('wtp-dstText');
const presetConvButtons = document.querySelectorAll('.wtp-presetConv');
const swapConvBtn = $('wtp-swapConv');
const resetBtn = $('wtp-resetBtn');
const adContainer = $('wtp-adContainer');

/* --- State & small helpers --- */
const STORAGE_KEY = 'wtpro_final_stable_v1';
let tzCities = []; // big DB (lazy)
let fuse = null;
let cities = [];
let countryIndex = {};

const COMPACT = [
  {label:'New York, USA', tz:'America/New_York', lat:40.7128, lon:-74.0060, cc:'US'},
  {label:'Los Angeles, USA', tz:'America/Los_Angeles', lat:34.0522, lon:-118.2437, cc:'US'},
  {label:'London, UK', tz:'Europe/London', lat:51.5074, lon:-0.1278, cc:'GB'},
  {label:'Paris, France', tz:'Europe/Paris', lat:48.8566, lon:2.3522, cc:'FR'},
  {label:'Mumbai, India', tz:'Asia/Kolkata', lat:19.0760, lon:72.8777, cc:'IN'},
  {label:'Tokyo, Japan', tz:'Asia/Tokyo', lat:35.6762, lon:139.6503, cc:'JP'},
  {label:'Sydney, Australia', tz:'Australia/Sydney', lat:-33.8688, lon:151.2093, cc:'AU'},
  {label:'Dubai, UAE', tz:'Asia/Dubai', lat:25.2048, lon:55.2708, cc:'AE'},
  {label:'Singapore', tz:'Asia/Singapore', lat:1.3521, lon:103.8198, cc:'SG'},
  {label:'Beijing, China', tz:'Asia/Shanghai', lat:39.9042, lon:116.4074, cc:'CN'}
];

fuse = new Fuse(COMPACT, { keys: ['label','tz'], threshold: 0.33, includeScore: true });

function ccToEmoji(cc){ if(!cc) return ''; return cc.toUpperCase().replace(/./g, ch => String.fromCodePoint(127397 + ch.charCodeAt(0))); }
function fmtOffset(m){ const sign = m>=0 ? '+' : '-'; const mm = Math.abs(m); const h = String(Math.floor(mm/60)).padStart(2,'0'); const mm2 = String(mm%60).padStart(2,'0'); return `${sign}${h}:${mm2}`; }
function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }

/* --- persistence --- */
function loadState(){
  // 1) hash payload
  try {
    const hash = location.hash.replace(/^#/,'');
    if(hash){
      const decoded = base64url.decode(hash);
      const parsed = JSON.parse(decoded);
      if(Array.isArray(parsed) && parsed.length > 0){ cities = parsed; saveState(); return; }
    }
  } catch(e){ console.warn('invalid hash payload', e); }
  // 2) localStorage
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length > 0){ cities = parsed; return; }
    }
  } catch(e){ console.warn('storage read failed', e); }

  // 3) seed defaults
  cities = [
    {label:'New York, USA', tz:'America/New_York', lat:40.7128, lon:-74.0060, cc:'US', flag:'ðŸ‡ºðŸ‡¸'},
    {label:'London, UK', tz:'Europe/London', lat:51.5074, lon:-0.1278, cc:'GB', flag:'ðŸ‡¬ðŸ‡§'},
    {label:'Mumbai, India', tz:'Asia/Kolkata', lat:19.0760, lon:72.8777, cc:'IN', flag:'ðŸ‡®ðŸ‡³'}
  ];
}
function saveState(){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(cities)); } catch(e){ console.warn('saveState failed', e); }
  try { const payload = base64url.encode(JSON.stringify(cities)); location.hash = payload; shareLink.value = location.href; } catch(e){ console.warn('hash update failed', e); }
}

/* --- Render cards --- */
function renderCards(){
  cardsEl.innerHTML = '';
  if(!Array.isArray(cities) || cities.length === 0){
    cities = [
      {label:'New York, USA', tz:'America/New_York', lat:40.7128, lon:-74.0060, cc:'US', flag:'ðŸ‡ºðŸ‡¸'},
      {label:'London, UK', tz:'Europe/London', lat:51.5074, lon:-0.1278, cc:'GB', flag:'ðŸ‡¬ðŸ‡§'},
      {label:'Mumbai, India', tz:'Asia/Kolkata', lat:19.0760, lon:72.8777, cc:'IN', flag:'ðŸ‡®ðŸ‡³'}
    ];
    saveState();
  }

  cities.forEach((c, idx) => {
    const card = document.createElement('article');
    card.className = 'wtp-card';
    card.tabIndex = 0;
    card.setAttribute('role','button');
    card.setAttribute('aria-label', `${c.label} local time card`);
    const flag = c.flag || (c.cc ? ccToEmoji(c.cc) : '');
    const latlon = (c.lat && c.lon) ? `${Number(c.lat).toFixed(3)}, ${Number(c.lon).toFixed(3)}` : '';
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="wtp-flag">${flag}</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="wtp-meta" style="font-weight:700">${c.label}</div>
              <div class="wtp-meta">${c.tz}${latlon ? ' â€¢ ' + latlon : ''}</div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="wtp-small wtp-remove" data-idx="${idx}" title="Remove">âœ–</button>
            </div>
          </div>
          <div class="wtp-timebig" id="wtp-time-${idx}">--:--:--</div>
          <div class="wtp-meta" id="wtp-date-${idx}">--</div>
          <div class="wtp-meta" id="wtp-sun-${idx}" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="wtp-tooltip" id="wtp-tip-${idx}"></div>
    `;
    cardsEl.appendChild(card);

    // behaviors
    card.addEventListener('mouseenter', ()=> showTip(idx));
    card.addEventListener('mouseleave', ()=> hideTip(idx));
    card.addEventListener('click', () => { const tip = $(`wtp-tip-${idx}`); if(tip) tip.classList.toggle('show'); });
    const rmBtn = card.querySelector('.wtp-remove');
    rmBtn.addEventListener('click', (ev) => { ev.stopPropagation(); const i = +ev.currentTarget.dataset.idx; cities.splice(i,1); saveState(); renderAll(); initMap(); });
  });
}

/* --- Tooltip --- */
function showTip(idx){
  const c = cities[idx]; const tip = $(`wtp-tip-${idx}`);
  if(!tip) return;
  try {
    const now = DateTime.now().setZone(c.tz);
    let sunriseText = '';
    if(c.lat && c.lon){
      try {
        const times = SunCalc.getTimes(new Date(), c.lat, c.lon);
        sunriseText = `${DateTime.fromJSDate(times.sunrise).setZone(c.tz).toFormat('HH:mm')} â€¢ ${DateTime.fromJSDate(times.sunset).setZone(c.tz).toFormat('HH:mm')}`;
      } catch(e){}
    }
    tip.innerHTML = `
      <div style="font-weight:700">${c.tz}</div>
      <div style="margin-top:6px;color:var(--wtp-muted)">Local: ${now.toFormat('cccc, dd LLL yyyy, HH:mm:ss')}</div>
      <div style="margin-top:6px;color:var(--wtp-muted)">UTC offset: UTC${fmtOffset(now.offset)}</div>
      <div style="margin-top:6px;color:var(--wtp-muted)">DST: ${now.isInDST ? 'Yes' : 'No'}</div>
      ${sunriseText ? `<div style="margin-top:6px;color:var(--wtp-muted)">Sunrise/Sunset: ${sunriseText}</div>` : ''}
      <div style="margin-top:8px;font-size:12px;color:var(--wtp-muted)">Tip: Use the map to add missing coordinates.</div>
    `;
    tip.classList.add('show');
  } catch(e){ tip.textContent = 'Error showing details'; tip.classList.add('show'); }
}
function hideTip(idx){ const tip = $(`wtp-tip-${idx}`); if(tip) tip.classList.remove('show'); }

/* --- Timeline (24-hour) --- */
function renderTimeline(selectedHour = null){
  const hours = Array.from({length:24}, (_,i)=>i);
  timelineEl.innerHTML = '';
  const header = document.createElement('div'); header.className = 'wtp-hourbar';
  header.innerHTML = `<div style="width:160px"></div>` + hours.map(h => `<div class="wtp-hour" data-hour="${h}">${h.toString().padStart(2,'0')}:00</div>`).join('');
  timelineEl.appendChild(header);

  cities.forEach((c) => {
    const row = document.createElement('div'); row.className = 'wtp-cityrow';
    const label = document.createElement('div'); label.className = 'wtp-citylabel';
    label.innerHTML = `<div style="font-weight:700">${c.label}</div><div class="wtp-meta">${c.tz}</div>`;
    row.appendChild(label);

    const container = document.createElement('div'); container.style.display = 'flex'; container.style.gap = '6px';
    hours.forEach(h => {
      const dtUtc = DateTime.utc().set({ hour: h, minute:0, second:0, millisecond:0 });
      const dtLocal = dtUtc.setZone(c.tz);
      const cell = document.createElement('div'); cell.className = 'wtp-hour'; cell.dataset.hour = h; cell.textContent = dtLocal.toFormat('HH');
      const nowLocalAt = DateTime.now().setZone(c.tz);
      if(dtLocal.hasSame(nowLocalAt, 'hour')) cell.classList.add('now');
      if(selectedHour !== null && Number(selectedHour) === h) cell.classList.add('selected');
      container.appendChild(cell);
    });

    row.appendChild(container);
    timelineEl.appendChild(row);
  });
}

/* Update vertical label */
vertSlider.addEventListener('input', (e) => {
  const val = Number(e.target.value);
  vertLabel.textContent = `Highlight hour: ${String(val).padStart(2,'0')}:00`;
  renderTimeline(val);
});

/* --- Meeting Planner & Suggestions --- */
applyPlanBtn.addEventListener('click', applyMeetingPlan);
function applyMeetingPlan(){
  plannerResult.innerHTML = '';
  if(!meetingDate.value || !meetingTime.value){ plannerResult.innerHTML = '<div class="wtp-meta">Pick a date and time.</div>'; return; }
  const durMin = Number(meetingDuration.value || 60);
  const [hh, mm] = meetingTime.value.split(':').map(Number);
  const baseLocal = DateTime.fromISO(meetingDate.value).set({ hour: hh, minute: mm, second:0 });
  const baseUtc = baseLocal.toUTC(); const endUtc = baseUtc.plus({ minutes: durMin });

  const listHtml = cities.map(c => {
    const s = baseUtc.setZone(c.tz), e = endUtc.setZone(c.tz);
    return `<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="display:flex;justify-content:space-between"><div><strong>${c.label}</strong><div class="wtp-meta">${c.tz}</div></div><div style="text-align:right"><div class="wtp-timebig">${s.toFormat('HH:mm')} â€” ${e.toFormat('HH:mm')}</div><div class="wtp-meta">${s.toFormat('cccc, dd LLL yyyy')}</div></div></div></div>`;
  }).join('');
  plannerResult.innerHTML = listHtml;

  // suggestions scan across the day
  const scanStart = DateTime.fromISO(meetingDate.value).startOf('day').toUTC();
  const slots = [];
  for(let i=0;i<48;i++){
    const slotStartUtc = scanStart.plus({ minutes: i*30 });
    const slotEndUtc = slotStartUtc.plus({ minutes: durMin });
    let score = 0; const details = [];
    cities.forEach(c => {
      const s = slotStartUtc.setZone(c.tz), e = slotEndUtc.setZone(c.tz);
      const within = (s.hour >= 9 && s.hour <= 17) && (e.hour >= 9 && e.hour <= 18);
      if(within) score++;
      details.push({city:c.label, start:s.toFormat('HH:mm'), within});
    });
    slots.push({slotStartUtc, score, details});
  }
  slots.sort((a,b)=> b.score - a.score || +a.slotStartUtc - +b.slotStartUtc);
  const suggestWrap = document.createElement('div'); suggestWrap.style.marginTop = '10px';
  suggestWrap.innerHTML = `<div class="wtp-meta">Top suggestions (maximize cities in 09:00â€“18:00):</div>`;
  const list = document.createElement('div'); list.style.marginTop = '6px';
  slots.slice(0,6).forEach(s => {
    const localUser = s.slotStartUtc.setZone(DateTime.now().zoneName);
    const el = document.createElement('div'); el.style.padding='8px'; el.style.border='1px solid rgba(255,255,255,0.02)'; el.style.marginBottom='6px';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${localUser.toFormat('dd LLL yyyy, HH:mm')}</strong><div class="wtp-meta">UTC ${s.slotStartUtc.toFormat('dd LLL yyyy, HH:mm')}</div></div><div style="text-align:right"><div class="wtp-meta">${s.score}/${cities.length} fit</div><button class="wtp-applySuggest wtp-btn" data-utc="${s.slotStartUtc.toISO()}">Apply</button></div></div><div style="margin-top:6px;font-size:13px;color:var(--wtp-muted)">Sample: ${s.details.slice(0,3).map(d => `${d.city} ${d.start}${d.within?' âœ“':''}`).join(' â€¢ ')}...</div>`;
    list.appendChild(el);
  });
  suggestWrap.appendChild(list); plannerResult.appendChild(suggestWrap);
  plannerResult.querySelectorAll('.wtp-applySuggest').forEach(btn => btn.addEventListener('click', (ev) => {
    const utcIso = ev.currentTarget.dataset.utc; const utc = DateTime.fromISO(utcIso);
    const local = utc.setZone(DateTime.now().zoneName);
    meetingDate.value = local.toISODate(); meetingTime.value = `${local.toFormat('HH')}:${local.toFormat('mm')}`; applyMeetingPlan();
  }));
}

/* --- Converter --- */
function populateConverterSelects(){
  convFrom.innerHTML = ''; convTo.innerHTML = '';
  cities.forEach(c => {
    const o = document.createElement('option'); o.value = c.tz; o.textContent = `${c.label} â€” ${c.tz}`; convFrom.appendChild(o); convTo.appendChild(o.cloneNode(true));
  });
  const common = ['Etc/UTC','America/New_York','America/Los_Angeles','Europe/London','Asia/Kolkata','Asia/Tokyo'];
  common.forEach(tz => {
    if(!Array.from(convFrom.options).some(o => o.value === tz)){
      const o = document.createElement('option'); o.value = tz; o.textContent = tz; convFrom.appendChild(o); convTo.appendChild(o.cloneNode(true));
    }
  });
}
convBtn.addEventListener('click', () => {
  if(!convFrom.value || !convTo.value || !convTime.value){ convOut.textContent = 'Pick From, To and time'; return; }
  const today = DateTime.now().setZone(convFrom.value).toISODate();
  const dt = DateTime.fromISO(`${today}T${convTime.value}`, {zone:convFrom.value});
  const out = dt.setZone(convTo.value);
  convOut.innerHTML = `${dt.toFormat('cccc, dd LLL yyyy, HH:mm')} (${convFrom.value}) â†’ <strong>${out.toFormat('cccc, dd LLL yyyy, HH:mm')} (${convTo.value})</strong>`;
});
presetConvButtons.forEach(btn => btn.addEventListener('click', (e) => {
  const f = e.currentTarget.dataset.from, t = e.currentTarget.dataset.to;
  convFrom.value = f; convTo.value = t;
  const now = DateTime.now().setZone(f);
  convTime.value = `${now.toFormat('HH')}:${now.toFormat('mm')}`; convBtn.click();
}));
if(swapConvBtn) swapConvBtn.addEventListener('click', () => { const a = convFrom.value; convFrom.value = convTo.value; convTo.value = a; });

/* --- Embed & share --- */
function updateEmbedShare(){
  try {
    const payload = base64url.encode(JSON.stringify(cities));
    const url = `${location.origin}${location.pathname}#${payload}`;
    embedCode.textContent = `<iframe src="${url}" width="340" height="220" frameborder="0" style="border-radius:8px"></iframe>`;
    shareLink.value = url;
  } catch(e){ console.warn('embed update failed', e); }
}
copyEmbed.addEventListener('click', () => navigator.clipboard?.writeText(embedCode.textContent).then(()=> alert('Embed code copied')).catch(()=> alert('Copy failed')));
shareBtn.addEventListener('click', ()=> { navigator.clipboard?.writeText(shareLink.value || window.location.href).then(()=> alert('Share link copied!')).catch(()=> alert('Copy failed')); });

/* --- Debounce utility --- */
function debounce(fn, wait = 200) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

/* --- Suggest UI & search --- */
addBtn.addEventListener('click', addCityFromInput);
searchInput.addEventListener('input', debounce((e)=> showSuggestions(e.target.value.trim()), 220));
searchInput.addEventListener('keydown', (e)=> {
  const list = suggestionsWrap.querySelectorAll('.wtp-suggest-item');
  const active = suggestionsWrap.querySelector('.wtp-suggest-item.active');
  if(e.key === 'Enter') { e.preventDefault(); if(active) active.click(); else addCityFromInput(); return; }
  if(e.key === 'ArrowDown'){ e.preventDefault(); if(list.length){ let next = active ? active.nextSibling : list[0]; if(!next) next = list[0]; setActiveSuggestion(next);} return; }
  if(e.key === 'ArrowUp'){ e.preventDefault(); if(list.length){ let prev = active ? active.previousSibling : list[list.length-1]; if(!prev) prev = list[list.length-1]; setActiveSuggestion(prev);} return; }
});
function setActiveSuggestion(el){
  suggestionsWrap.querySelectorAll('.wtp-suggest-item').forEach(i => i.classList.remove('active'));
  if(el) el.classList.add('active'); el?.scrollIntoView({block:'nearest'});
}

function showSuggestions(q){
  suggestionsWrap.innerHTML = ''; suggestionsWrap.setAttribute('aria-hidden','true');
  if(!q) return;
  q = String(q).trim();

  let results = [];
  let fuseResults = [];

  try {
    if(fuse){
      const res = fuse.search(q, {limit: 20});
      fuseResults = res.map(r => ({ item: r.item, score: (r.score != null ? r.score : 1) }));
    }
  } catch(e){ console.warn('Fuse search error', e); }

  results = fuseResults.map(r => Object.assign({}, r.item, { _score: r.score }));

  try {
    if(countryIndex && typeof countryIndex === 'object'){
      const qLower = q.toLowerCase();
      Object.keys(countryIndex).forEach(countryName => {
        if(countryName.toLowerCase().includes(qLower) || qLower.includes(countryName.toLowerCase())){
          const tzs = countryIndex[countryName] || [];
          tzs.forEach(tz => {
            const entry = tzCities.find(x => x.tz === tz || (x.label && x.label.toLowerCase().includes(tz.toLowerCase())));
            if(entry) results.push(Object.assign({}, entry, { _score: 0.05 }));
          });
        }
      });
      if(q.length <= 3){
        const code = q.toUpperCase();
        tzCities.forEach(entry => { if(entry.cc && entry.cc.toUpperCase() === code) results.push(Object.assign({}, entry, { _score: 0.05 })); });
      }
    }
  } catch(e){ console.warn('countryIndex lookup error', e); }

  if(results.length === 0 && Array.isArray(tzCities) && tzCities.length){
    const qq = q.toLowerCase();
    results = tzCities.filter(it => {
      const label = (it.label || '').toLowerCase();
      const tz = (it.tz || '').toLowerCase();
      return label.includes(qq) || tz.includes(qq);
    }).slice(0, 30).map(r => Object.assign({}, r, { _score: 0.5 }));
  }

  if(results.length === 0 && Array.isArray(COMPACT)){
    const qq = q.toLowerCase();
    results = COMPACT.filter(it => ((it.label || '').toLowerCase().includes(qq) || (it.tz || '').toLowerCase().includes(qq))).slice(0,12).map(r => Object.assign({}, r, {_score:0.6}));
  }

  if(!results || results.length === 0) return;

  const byTz = new Map();
  results.forEach(r => { if(r && r.tz) byTz.set(r.tz, r); });

  let final = Array.from(byTz.values());

  final.sort((a,b) => {
    const sa = (a._score != null ? a._score : 1);
    const sb = (b._score != null ? b._score : 1);
    if(sa !== sb) return sa - sb;
    const wa = (a.weight||0), wb = (b.weight||0);
    return wb - wa;
  });

  final = final.slice(0, 12);

  const wrap = document.createElement('div'); wrap.className = 'wtp-suggest-list';
  final.forEach(r => {
    const it = document.createElement('div'); it.className = 'wtp-suggest-item'; it.tabIndex = 0;
    const label = r.label || r.tz || String(r);
    const tz = r.tz || '';
    const meta = (r.cc ? `${r.cc} â€¢ ` : '') + tz;
    const strong = document.createElement('strong'); strong.textContent = label;
    const metaEl = document.createElement('div'); metaEl.className = 'wtp-meta'; metaEl.style.fontSize = '12px'; metaEl.textContent = meta;
    it.appendChild(strong);
    it.appendChild(metaEl);

    it.addEventListener('click', ()=> {
      cities.push({ label: r.label || label, tz: r.tz || tz, lat: r.lat || null, lon: r.lon || null, cc: r.cc || null, flag: r.cc ? ccToEmoji(r.cc) : '' });
      saveState(); renderAll(); suggestionsWrap.innerHTML = ''; searchInput.value = ''; initMap();
    });
    it.addEventListener('keydown', ev => { if(ev.key === 'Enter') it.click(); });
    wrap.appendChild(it);
  });

  suggestionsWrap.appendChild(wrap);
  suggestionsWrap.setAttribute('aria-hidden','false');
}

/* --- addCityFromInput (fixed) --- */
function addCityFromInput(){
  const q = (searchInput.value || '').trim();
  if(!q) return;

  let found = null;
  if (Array.isArray(tzCities) && tzCities.length) {
    found = tzCities.find(t => (t.label || '').toLowerCase() === q.toLowerCase() || (t.tz || '').toLowerCase() === q.toLowerCase());
  }

  if (!found && fuse) {
    try {
      const res = fuse.search(q, { limit: 10 });
      if (Array.isArray(res) && res.length > 0) {
        const top = res[0];
        found = (top && top.item) ? top.item : top;
      }
    } catch (err) {
      console.warn('Fuse search error in addCityFromInput:', err);
    }
  }

  if (!found) {
    alert('City not found in list. Try a different name or IANA zone.');
    return;
  }

  cities.push({
    label: found.label || found.tz || q,
    tz: found.tz || found.value || q,
    lat: safeNum(found.lat),
    lon: safeNum(found.lon),
    cc: found.cc || null,
    flag: found.cc ? ccToEmoji(found.cc) : (found.flag || '')
  });

  saveState();
  searchInput.value = '';
  suggestionsWrap.innerHTML = '';
  renderAll();
  try { initMap(); } catch(e){ /* ignore */ }
}

/* --- DST ticker --- */
function scanDst(){
  try {
    const changes = [];
    const now = DateTime.now();
    const days = 90;
    cities.forEach(c => {
      if(!c.tz) return;
      let prev = DateTime.now().setZone(c.tz).offset;
      for(let d=1; d<=days; d++){
        const dt = now.plus({ days: d }).setZone(c.tz);
        if(dt.offset !== prev){ changes.push({city:c.label, date: dt.toISODate(), oldOffset: prev, newOffset: dt.offset}); break; }
      }
    });
    if(changes.length===0) dstText.textContent = 'No DST changes detected for your cities in next 90 days.';
    else {
      changes.sort((a,b)=> new Date(a.date) - new Date(b.date));
      const s = changes[0];
      dstText.textContent = `Upcoming DST: ${s.city} on ${s.date} â€” from UTC${fmtOffset(s.oldOffset)} to UTC${fmtOffset(s.newOffset)}`;
    }
  } catch(e){ console.warn('DST scan failed', e); dstText.textContent = 'DST ticker unavailable'; }
}

/* --- Map init & markers (improved) --- */
let map = null, markers = [];
function clearMarkers(){
  if(!map) return;
  try {
    markers.forEach(m => {
      try { map.removeLayer(m); } catch(e){}
    });
  } catch(e){}
  markers = [];
}

function initMap(){
  try {
    const mpEl = document.getElementById('wtp-map');
    if(!mpEl) return;

    if(!map){
      map = L.map('wtp-map', { dragging: true, attributionControl: false }).setView([20,0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
      setTimeout(()=> { try { map.invalidateSize(); } catch(e){} }, 150);
    } else {
      clearMarkers();
    }

    const useClustering = !!(L && typeof L.markerClusterGroup === 'function');
    let clusterGroup = null;
    if (useClustering) clusterGroup = L.markerClusterGroup();

    const MAX_MARKERS = 800; 
    let count = 0;

    if (Array.isArray(tzCities) && tzCities.length) {
      for (const tc of tzCities) {
        if (tc == null) continue;
        if (tc.lat == null || tc.lon == null) continue;
        if (count >= MAX_MARKERS) break;
        count++;

        if (useClustering) {
          const mk = L.marker([tc.lat, tc.lon]);
          mk.bindTooltip(`${tc.label} â€” ${tc.tz}`);
          mk.on('mouseover', ()=> {
            const dt = DateTime.now().setZone(tc.tz);
            mk.setTooltipContent(`${tc.label}<br>${dt.toFormat('HH:mm:ss')} (UTC${fmtOffset(dt.offset)})`);
            mk.openTooltip();
          });
          mk.on('click', ()=> {
            cities.push({label: tc.label, tz: tc.tz, lat: tc.lat, lon: tc.lon, cc: tc.cc, flag: tc.cc ? ccToEmoji(tc.cc) : ''});
            saveState(); renderAll(); initMap();
          });
          clusterGroup.addLayer(mk);
          markers.push(mk);
        } else {
          const mark = L.circleMarker([tc.lat, tc.lon], { radius:5, fillOpacity:0.9 });
          mark.bindTooltip(`${tc.label} â€” ${tc.tz}`);
          mark.on('mouseover', ()=> {
            const dt = DateTime.now().setZone(tc.tz);
            mark.setTooltipContent(`${tc.label}<br>${dt.toFormat('HH:mm:ss')} (UTC${fmtOffset(dt.offset)})`);
            mark.openTooltip();
          });
          mark.on('click', ()=> {
            cities.push({label: tc.label, tz: tc.tz, lat: tc.lat, lon: tc.lon, cc: tc.cc, flag: tc.cc ? ccToEmoji(tc.cc) : ''});
            saveState(); renderAll(); initMap();
          });
          mark.addTo(map);
          markers.push(mark);
        }
      }
    }

    if (useClustering && clusterGroup) {
      map.addLayer(clusterGroup);
      markers.push(clusterGroup);
    }

    // Add selected cities markers (highlight)
    if (Array.isArray(cities) && cities.length) {
      for (const c of cities) {
        if (!c || c.lat == null || c.lon == null) continue;
        const msel = L.circleMarker([c.lat, c.lon], { radius:6, color:'#a23a3a', weight:1, fillOpacity:0.95 }).addTo(map);
        msel.bindTooltip(`${c.label} â€” ${c.tz}`);
        msel.on('mouseover', ()=> {
          const dt = DateTime.now().setZone(c.tz);
          msel.setTooltipContent(`${c.label}<br>${dt.toFormat('HH:mm:ss')} (UTC${fmtOffset(dt.offset)})`);
          msel.openTooltip();
        });
        markers.push(msel);
      }
    }

    if (!markers.length) {
      mpEl.innerHTML = '<div class="wtp-meta" style="padding:12px">No map markers available â€” add a city with coordinates or bundle timezones.json with coords.</div>';
    }

  } catch(e) {
    console.warn('Map init error', e);
    const mp = document.getElementById('wtp-map'); if(mp) mp.innerHTML = '<div class="wtp-meta">Map could not load</div>';
  }
}

/* --- Export Image --- */
exportImageBtn.addEventListener('click', () => {
  const wrapper = document.createElement('div');
  wrapper.style.background = '#071323'; wrapper.style.padding = '12px'; wrapper.style.borderRadius = '8px';
  wrapper.appendChild(cardsEl.cloneNode(true)); wrapper.appendChild(timelineEl.cloneNode(true));
  document.body.appendChild(wrapper);
  html2canvas(wrapper, {backgroundColor: null, scale:2}).then(canvas => {
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = 'worldtime.png'; a.click();
    document.body.removeChild(wrapper);
  }).catch(err => {
    alert('Export failed: ' + String(err));
  });
});

/* --- Countdown (improved) --- */
let countdownInterval = null;
$('wtp-startCount')?.addEventListener?.('click', ()=> {
  const d = $('wtp-countDate').value;
  const t = $('wtp-countTime').value;
  const out = $('wtp-countRes');

  if(!d || !t){ out.textContent = 'Pick date & time'; return; }

  const target = DateTime.fromISO(`${d}T${t}`);
  if(!target.isValid){ out.textContent = 'Invalid date/time'; return; }

  if(countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

  function tickCount(){
    const now = DateTime.now();
    if(target <= now) {
      out.textContent = 'Event reached!';
      if(countdownInterval){ clearInterval(countdownInterval); countdownInterval = null; }
      return;
    }
    const diff = target.diff(now, ['days','hours','minutes','seconds']).toObject();
    const days = Math.floor(diff.days || 0);
    const hours = Math.floor(diff.hours || 0);
    const minutes = Math.floor(diff.minutes || 0);
    const seconds = Math.floor(diff.seconds || 0);
    out.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  tickCount();
  countdownInterval = setInterval(tickCount, 1000);
});

/* --- Tick / main loop (single) --- */
let lastTimelineUpdate = 0;
function tick(){
  const nowTs = Date.now();
  const now = DateTime.fromMillis(nowTs);

  cities.forEach((c, idx) => {
    const timeEl = $(`wtp-time-${idx}`), dateEl = $(`wtp-date-${idx}`), sunEl = $(`wtp-sun-${idx}`);
    if(!timeEl) return;
    try {
      const dt = now.setZone(c.tz);
      timeEl.textContent = dt.toFormat('HH:mm:ss');
      dateEl.textContent = dt.toFormat('cccc, dd LLL yyyy');

      if(c.lat && c.lon){
        const times = SunCalc.getTimes(new Date(nowTs), c.lat, c.lon);
        const sr = DateTime.fromJSDate(times.sunrise).setZone(c.tz).toFormat('HH:mm');
        const ss = DateTime.fromJSDate(times.sunset).setZone(c.tz).toFormat('HH:mm');
        sunEl.textContent = `Sunrise ${sr} â€¢ Sunset ${ss}`;
      } else {
        sunEl.textContent = '';
      }

      const tip = $(`wtp-tip-${idx}`);
      if(tip && tip.classList.contains('show')) showTip(idx);
    } catch(e) {
      console.warn('tick update failed', e);
    }
  });

  if (nowTs - lastTimelineUpdate > 8000) {
    renderTimeline(Number(vertSlider.value || 0));
    lastTimelineUpdate = nowTs;
  }

  scanDst();
  updateEmbedShare();
}

// ensure tick runs once
if (typeof window !== 'undefined') {
  if (!window.__wtp_tick_started__) {
    setInterval(tick, 1000);
    window.__wtp_tick_started__ = true;
  }
}

/* --- IANA DB loader --- */
async function loadIanaDB(){
  const localTz = './timezones.json';
  const localIdx = './country_to_zones_index.json';
  let raw = null, idxRaw = null;

  try {
    const r = await fetch(localTz, {cache:'reload'});
    if(r.ok) raw = await r.json();
  } catch(e){ console.warn('local tz fetch failed', e); }

  try {
    const r2 = await fetch(localIdx, {cache:'reload'});
    if(r2.ok) idxRaw = await r2.json();
  } catch(e){ console.warn('local country index fetch failed', e); }

  if(!raw){
    try {
      const resp = await fetch('https://raw.githubusercontent.com/dmfilipenko/timezones.json/master/timezones.json',{cache:'reload'});
      if(resp.ok) raw = await resp.json();
    } catch(e){ console.warn('remote tz fetch failed', e); }
  }

  if(!raw || !Array.isArray(raw) || raw.length === 0){
    console.warn('No timezone DB loaded, falling back to COMPACT list.');
    tzCities = COMPACT.slice();
    fuse = new Fuse(tzCities, { keys: ['label','tz'], threshold: 0.33, includeScore: true });
    countryIndex = idxRaw || {};
    return;
  }

  tzCities = raw.map(item => {
    const tz = item.tz || item.value || item.name || String(item);
    const label = item.label || item.name || (typeof item.value === 'string' ? item.value.split('/').pop().replace(/_/g,' ') + ' ('+ tz +')' : tz);
    return {
      label: String(label),
      tz: String(tz),
      lat: safeNum(item.lat),
      lon: safeNum(item.lon),
      cc: item.cc || item.country || null,
      weight: Number(item.weight || 0)
    };
  });

  for(const c of COMPACT){
    const found = tzCities.find(t => t.tz === c.tz);
    if(found){ found.lat = found.lat || c.lat; found.lon = found.lon || c.lon; found.cc = found.cc || c.cc; found.label = found.label || c.label; found.weight = Math.max(found.weight||0, 500); }
  }

  const seen = new Set(); tzCities = tzCities.filter(t => { if(seen.has(t.tz)) return false; seen.add(t.tz); return true; });

  fuse = new Fuse(tzCities, { keys: ['label','tz'], threshold: 0.33, includeScore: true });
  countryIndex = idxRaw || {};

  console.log('tzCities loaded, count=', tzCities.length, 'countryIndex keys=', Object.keys(countryIndex).length);
}

/* --- Misc handlers --- */
$('wtp-copyEmbed').addEventListener('click', ()=> navigator.clipboard?.writeText(embedCode.textContent).then(()=> alert('Embed copied')).catch(()=> alert('Copy failed')));
$('wtp-resetBtn').addEventListener('click', ()=> { if(confirm('Reset to default cities?')) { cities = [{label:'New York, USA',tz:'America/New_York',lat:40.7128,lon:-74.0060,flag:'ðŸ‡ºðŸ‡¸'},{label:'London, UK',tz:'Europe/London',lat:51.5074,lon:-0.1278,flag:'ðŸ‡¬ðŸ‡§'},{label:'Mumbai, India',tz:'Asia/Kolkata',lat:19.0760,lon:72.8777,flag:'ðŸ‡®ðŸ‡³'}]; saveState(); renderAll(); initMap(); } });

/* --- Render all --- */
function renderAll(){ renderCards(); populateConverterSelects(); renderTimeline(Number(vertSlider.value)); updateEmbedShare(); scanDst(); }

/* --- Boot (robust order) --- */
(async function boot(){
  try { await loadIanaDB(); } catch(e){ console.warn('loadIanaDB failed in boot', e); }
  try { loadState(); } catch(e){ console.warn('loadState failed', e); }
  try { initMap(); } catch(e) { console.warn('map init error', e); }
  try { renderAll(); } catch(e){ console.warn('renderAll failed', e); }
  try { tick(); } catch(e){ console.warn('initial tick failed', e); }
})();
 
/* --- Keyboard nav for suggestions --- */
document.addEventListener('keydown', (e)=>{
  const list = suggestionsWrap.querySelectorAll('.wtp-suggest-item');
  if(!list.length) return;
  const active = suggestionsWrap.querySelector('.wtp-suggest-item.active');
  if(e.key === 'ArrowDown'){ e.preventDefault(); const next = active ? (active.nextSibling || list[0]) : list[0]; setActiveSuggestion(next); }
  if(e.key === 'ArrowUp'){ e.preventDefault(); const prev = active ? (active.previousSibling || list[list.length-1]) : list[list.length-1]; setActiveSuggestion(prev); }
  if(e.key === 'Enter' && active){ active.click(); }
});

/* --- Debug helpers --- */
window.WorldTimePro = {
  getCities: ()=>cities,
  setCities: (arr)=> { if(Array.isArray(arr)){ cities = arr; saveState(); renderAll(); initMap(); } }
};
</script>

</body>
</html>
